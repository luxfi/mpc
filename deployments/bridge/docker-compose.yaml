version: '3.8'

services:
  # NATS messaging system
  nats:
    image: nats:2.10-alpine
    ports:
      - "4222:4222"
      - "8222:8222"
    command: "-js -m 8222"
    networks:
      - mpc-network
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "4222"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Consul for service discovery
  consul:
    image: consul:1.17
    ports:
      - "8500:8500"
    command: "agent -dev -client=0.0.0.0"
    networks:
      - mpc-network
    healthcheck:
      test: ["CMD", "consul", "members"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Lux MPC Node 0
  lux-mpc-0:
    image: luxfi/lux-mpc:latest
    build:
      context: ../..
      dockerfile: Dockerfile
    environment:
      - NODE_ID=node0
      - NATS_URL=nats://nats:4222
      - CONSUL_URL=http://consul:8500
      - DB_PATH=/data/mpc
      - HTTP_PORT=8080
      - GRPC_PORT=9090
      - LOG_LEVEL=debug
    volumes:
      - mpc-data-0:/data
    ports:
      - "8080:8080"
      - "9090:9090"
    networks:
      - mpc-network
    depends_on:
      nats:
        condition: service_healthy
      consul:
        condition: service_healthy

  # Bridge Compatibility Layer for Node 0
  bridge-compat-0:
    image: luxfi/lux-mpc:latest
    command: ["/usr/local/bin/lux-mpc-bridge", "--mpc-endpoint", "http://lux-mpc-0:8080", "--port", "6000"]
    environment:
      - LUX_MPC_ENDPOINT=http://lux-mpc-0:8080
      - BRIDGE_PORT=6000
    ports:
      - "6000:6000"
    networks:
      - mpc-network
    depends_on:
      - lux-mpc-0

  # Lux MPC Node 1
  lux-mpc-1:
    image: luxfi/lux-mpc:latest
    build:
      context: ../..
      dockerfile: Dockerfile
    environment:
      - NODE_ID=node1
      - NATS_URL=nats://nats:4222
      - CONSUL_URL=http://consul:8500
      - DB_PATH=/data/mpc
      - HTTP_PORT=8080
      - GRPC_PORT=9090
      - LOG_LEVEL=debug
    volumes:
      - mpc-data-1:/data
    ports:
      - "8081:8080"
      - "9091:9090"
    networks:
      - mpc-network
    depends_on:
      nats:
        condition: service_healthy
      consul:
        condition: service_healthy

  # Bridge Compatibility Layer for Node 1
  bridge-compat-1:
    image: luxfi/lux-mpc:latest
    command: ["/usr/local/bin/lux-mpc-bridge", "--mpc-endpoint", "http://lux-mpc-1:8080", "--port", "6000"]
    environment:
      - LUX_MPC_ENDPOINT=http://lux-mpc-1:8080
      - BRIDGE_PORT=6000
    ports:
      - "6001:6000"
    networks:
      - mpc-network
    depends_on:
      - lux-mpc-1

  # Lux MPC Node 2
  lux-mpc-2:
    image: luxfi/lux-mpc:latest
    build:
      context: ../..
      dockerfile: Dockerfile
    environment:
      - NODE_ID=node2
      - NATS_URL=nats://nats:4222
      - CONSUL_URL=http://consul:8500
      - DB_PATH=/data/mpc
      - HTTP_PORT=8080
      - GRPC_PORT=9090
      - LOG_LEVEL=debug
    volumes:
      - mpc-data-2:/data
    ports:
      - "8082:8080"
      - "9092:9090"
    networks:
      - mpc-network
    depends_on:
      nats:
        condition: service_healthy
      consul:
        condition: service_healthy

  # Bridge Compatibility Layer for Node 2
  bridge-compat-2:
    image: luxfi/lux-mpc:latest
    command: ["/usr/local/bin/lux-mpc-bridge", "--mpc-endpoint", "http://lux-mpc-2:8080", "--port", "6000"]
    environment:
      - LUX_MPC_ENDPOINT=http://lux-mpc-2:8080
      - BRIDGE_PORT=6000
    ports:
      - "6002:6000"
    networks:
      - mpc-network
    depends_on:
      - lux-mpc-2

volumes:
  mpc-data-0:
  mpc-data-1:
  mpc-data-2:

networks:
  mpc-network:
    driver: bridge